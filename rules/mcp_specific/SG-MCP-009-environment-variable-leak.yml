id: SG-MCP-009
name: Environment Variable Leak via MCP Tools
description: >
  Detects patterns in MCP tool definitions or configurations that
  expose environment variables through tool outputs, error messages,
  or logging. Attackers can craft tools that read sensitive environment
  variables (API keys, database credentials, secrets) and include them
  in tool responses, effectively leaking them to the LLM context or
  to external endpoints.
severity: critical
category: mcp_specific
owasp_llm: [LLM06]
mitre_attack: [T1552.001, T1082]
target: ANY
engine: REGEX
pattern:
  any:
    - "(?i)(process\\.env|os\\.environ|os\\.getenv|ENV\\[|System\\.getenv|env::|\\$ENV\\{|getenv\\()\\s*\\.?\\s*[\\[(\"']?.{0,60}(return|respond|output|send|print|log|include|append|concat|join|format|write)"
    - "(?i)(return|respond|output|send|result)\\s*.{0,40}(process\\.env|os\\.environ|os\\.getenv|ENV\\[|System\\.getenv|\\$ENV)"
    - "(?i)(JSON\\.stringify|json\\.dumps|to_json|serialize|repr|inspect)\\s*\\(\\s*(process\\.env|os\\.environ|ENV)"
    - "(?i)(list|dump|enumerate|iterate|loop|Object\\.keys|Object\\.entries|vars|dir)\\s*\\(\\s*(process\\.env|os\\.environ|ENV)"
    - "(?i)(error|exception|stack[_\\-]?trace|debug|verbose)\\s*.{0,40}(env|environment|process\\.env|os\\.environ)"
    - "(?i)for\\s+.{0,20}\\s+in\\s+.{0,20}(process\\.env|os\\.environ|ENV)\\b"
    - "(?i)(child_process|subprocess|exec|spawn|popen)\\s*\\(.{0,40}(env|printenv|set\\b|export)"
    - "(?i)(tool[_\\-]?result|tool[_\\-]?output|tool[_\\-]?response|content)\\s*[=:].{0,60}(process\\.env|os\\.environ|os\\.getenv|ENV)"
    - "(?i)\\$\\{(\\w*KEY\\w*|\\w*SECRET\\w*|\\w*TOKEN\\w*|\\w*PASSWORD\\w*|\\w*CREDENTIAL\\w*|DATABASE_URL|REDIS_URL|MONGO_URI)\\}"
false_positive_notes: >
  Tools that need specific environment variables for their own
  configuration (e.g., reading a PORT or HOST variable) may trigger
  this rule. The concern is tools that expose arbitrary environment
  variables or sensitive credentials through their output rather than
  using them internally.
remediation: >
  Never include raw environment variables in tool responses. Use
  allowlists for environment variable access, limiting tools to only
  the specific variables they need. Sanitize error messages and logs
  to remove environment variable values. Use secret management services
  instead of environment variables for sensitive credentials.
references:
  - https://genai.owasp.org/llmrisk/llm06-excessive-agency/
  - https://cwe.mitre.org/data/definitions/526.html
  - https://attack.mitre.org/techniques/T1552/001/
enabled: true
